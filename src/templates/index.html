{% extends "layout.html" %}

{% block title %}
LatexLab
{% endblock %}

{% block body %}
<h1>LatexLab</h1>

<ul>
    <div><a href="/new_citation" class="btn btn-primary btn-sm">New Citation</a></div>
    
    {% if citations|length > 0 %}
        <input type="text" id="citationSearch" placeholder="Filter citations..." onkeyup="filterCitations()">
        <p id="searchFor" class="d-none">Search for: <span></span></p>
        <div>
            <button class="btn btn-success btn-sm" onclick="saveAllBibtexToFile()">Save all as BibTex</button>
        </div>
       
    {% endif %}

    {% for citation in citations %}
    <lu>
        <div class="citation-item">
            <strong>Type:</strong> {{ citation.type }} <br>
            <strong>Author:</strong> {{ citation.author }} <br>
            <strong>Title:</strong> {{ citation.title }} <br>
            <strong>Year:</strong> {{ citation.year }} <br>
            
            {% if citation.type == "article" %}
                <strong>Journal:</strong> {{ citation.journal }} <br>
                <strong>Volume:</strong> {{ citation.volume }} <br>
                <strong>Pages:</strong> {{ citation.pages }} <br>
            {% elif citation.type == "inproceeding" %}
                <strong>Book title:</strong> {{ citation.booktitle }} <br>
            {% elif citation.type == "book" %}
                <strong>Publisher:</strong> {{ citation.publisher }} <br>
            {% endif %}

            <form action="/delete_citation/{{ citation.id }}" method="POST">
                <input type="hidden" name="id" value="{{ citation.id }}">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
            </form>
            <form action="/edit_citation/{{ citation.id }}" method="GET">
                <input  type="hidden" name="id" value="{{ citation.id }}">
                <button type="submit" class="btn btn-secondary btn-sm">Edit</button>
            </form>
        </div>
            
        

        <button type="button" class="btn btn-dark btn-sm" bibtex-clipboard-data="{{ citation.as_bibtex }}" onclick="toClipboard(this)">Bibtex to
            clipboard</button>
        <button type="button" class="btn btn-dark btn-sm" bibtex-file-data="{{ citation.as_bibtex }}" onclick="toFile(this)">Save as BibTex</button>
        <br>
    </lu>
    {% else %}
    <li>You don't have any citations</li>
    {% endfor %}
    <li id="noResultsMessage" style="display:none;">No citations found</li>
</ul>

<script>
    function filterCitations() {
        const input = document.getElementById('citationSearch');
        const searchForElement = document.getElementById('searchFor');
        const searchTermDisplay = document.querySelector('#searchFor span');
        const filter = input.value.toLowerCase();
        const citations = document.querySelectorAll('.citation-item');
        const saveAllButton = document.querySelector('button[onclick="saveAllBibtexToFile()"]');
        let hasVisibleCitations = false;

        citations.forEach(citation => {
            const listItem = citation.closest('li')
            const citationText = citation.innerText.toLowerCase();

            if (citationText.includes(filter)) {
                listItem.style.display = '';
                hasVisibleCitations = true;
        } else {
            listItem.style.display = 'none';
        }

        searchTermDisplay.textContent = input.value;

        if (input.value.trim() === '') {
            saveAllButton.style.display = '';
            searchForElement.classList.add('d-none');
        } else {
            searchTermDisplay.style.display = 'none'
            searchForElement.classList.remove('d-none');
        }
        });

        const noResultsMessage = document.getElementById('noResultsMessage');
        if (hasVisibleCitations) {
            noResultsMessage.style.display = 'none';
        } else {
            noResultsMessage.style.display = 'block';
        }
    }

    function toClipboard(buttonElement) {
        const text = buttonElement.getAttribute('bibtex-clipboard-data');
        navigator.clipboard.writeText(text);
    }

    function toFile(buttonElement) {
        const text = buttonElement.getAttribute('bibtex-file-data');
        const blob = new Blob([text], { type: 'application/x-bibtex' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'citations.bib';
        link.click();
    }

    function saveAllBibtexToFile() {
        const citationButtons = document.querySelectorAll('button[bibtex-file-data]');
        let allBibtexData = '';

        citationButtons.forEach(button => {
            allBibtexData += button.getAttribute('bibtex-file-data') + '\n';
        });

        if (allBibtexData) {
            const tempButton = document.createElement('button');
            tempButton.setAttribute('bibtex-file-data', allBibtexData);
            toFile(tempButton);
        }
    }



</script>
{% endblock %}